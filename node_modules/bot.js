var fs = require('fs'),
irc = require("irc"),
listeners = {};

require('plugins.js').watch();

exports.triggers = [];

var client = exports.client = new irc.Client('irc.efnet.org', 'hilde', {
    userName: 'tihihilde',
    realName: 'tihihilde',
    channels: ['#testfrest']
});

exports.addListener = function(obj, type, fn) {
    client.addListener(type, fn);
    if (!listeners[obj]) {
        listeners[obj] = [];
    }
    listeners[obj].push({
        type: type,
        fn: fn
    });
};

exports.removeListeners = function(obj) {
    listeners[obj].forEach(function(l) {
        client.removeListener(l.type, l.fn);
    });
};

exports.onTrigger = function(obj, triggerKey, callback) {
    this.triggers.push(triggerKey);
    var regexp = '!' + triggerKey + ' ';
    this.addListener(obj, 'message', function(from, to, msg) {
        if (msg.match(regexp)) {
            try {
                callback(from, to, msg.replace(regexp, ''));
            } catch(e) {
                console.log('Trigger error for %s:', triggerKey, e);
            }
        }
    });
};

